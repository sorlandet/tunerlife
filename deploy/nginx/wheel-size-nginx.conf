upstream automobile_server {
    # fail_timeout=0 means we always retry an upstream even if it failed
    # to return a good HTTP response (in case the Unicorn master nukes a
    # single worker for timing out).

    # for UNIX domain socket setups:
    server unix:/tmp/gunicorn.sock fail_timeout=0;

    # for TCP setups, point these to your backend servers
    # server  127.0.0.1:9001 fail_timeout=0;
}

# Redirect all requests on the www subdomain to the root domain
server {
    listen      80;
    server_name wheel-size.com;
    rewrite ^/(.*) http://www.wheel-size.com/$1 permanent;
}

server {
    listen      80;
    server_name www.razmerkoles.ru;
    rewrite ^/(.*) http://razmerkoles.ru/$1 permanent;
}

# Serve static files and redirect any other request to Apache
server {
    listen       80;
    server_name  www.wheel-size.com razmerkoles.ru;

    # path for static files
    root /opt/www/private/automobile;

    access_log  /var/log/automobile/nginx/access.log;
    error_log  /var/log/automobile/nginx/error.log;

    ## Only allow these request methods ##
    #if ($request_method !~ ^(GET|HEAD|POST)$ ) {
    #    return 444;
    #}
    ## Do not accept DELETE, SEARCH and other methods ##

    ## Deny certain Referers ###
    #if ( $http_referer ~* (babes|forsale|girl|jewelry|love|nudit|organic|poker|porn|sex|teen) ) {
    #    # return 404;
    #    return 403;
    #}
    ##

    # Stop deep linking or hot linking
    location ^~ /static {
        access_log off;
        expires 7d;
#        valid_referers none blocked finlay.dev.thumbtack.net;
#        if ($invalid_referer) {
#            return 403;
#        }
    }

    location ^~ /media {
        access_log off;
        expires 7d;
#        valid_referers none blocked finlay.dev.thumbtack.net;
#        if ($invalid_referer) {
#            return 403;
#        }
    }

    location /167c44d98c69.html {
      root  /opt/www/production/automobile/static;
    }
    location /BingSiteAuth.xml {
      root  /opt/www/production/automobile/static;
    }

    # One of the ads coming from one of the providers is incorrectly making
    # a request to: /eyeblaster/addineyev2.html
    location ~* ^/eyeblaster/addineyeV2.html/ {
      try_files $uri /eyeblaster/addineyeV2.html;
    }
    location = /eyeblaster/addineyeV2.html {
      root  /opt/www/production/automobile/static;
    }


    # Rewrite some old urls
    if ( $request_filename ~ size/mercedes-benz/ ) {
        rewrite ^ http://$host/size/mercedes/? permanent;
    }

    if ( $request_filename ~ calc/ ) {
        rewrite ^ http://$host/tire_calculator/? permanent;
    }

    try_files $uri @proxy_to_app;

    if ($host ~* \.ru$) {
        set $language 'ru-RU';
    }

    if ($host ~* \.com$) {
        set $language 'en-US';
    }

    # Setup named location for Django requests and handle proxy details
    location @proxy_to_app {
        proxy_pass         http://automobile_server;
        proxy_redirect     off;
        proxy_set_header   Host             $host;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_set_header   Accept-Language  $language;
    }
}